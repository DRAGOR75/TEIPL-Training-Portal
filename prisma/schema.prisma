generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
}

// 1. Master Employee Table (For initial ID verification)
model Employee {
  id                String        @id @map("emp_id") // Your official Employee ID
  name              String
  email             String        @unique
  grade             Grade?         // EXECUTIVE or WORKMAN
  sectionName       String?       @map("section_name") // Their home department
  location          String?
  mobile            String?
  designation       String?
  yearsOfExperience String?       @map("years_of_experience")
  subDepartment     String?       @map("sub_department")
  gender            Gender?
  managerName       String?       @map("manager_name")
  managerEmail      String?       @map("manager_email")
  programName       String?       @map("program_name")
  startDate         DateTime?     @map("start_date")
  endDate           DateTime?     @map("end_date")  
  
  // Relations
  nominations       Nomination[]  // Links to their training requests
  cohortMemberships CohortMember[]  // Cohort journeys
  cohortFeedbacks   CohortFeedback[] // Cohort-level feedback
  
  @@map("employees")
}

enum Grade {
  EXECUTIVE
  WORKMAN
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

// 2. Section Table (The 20+ Departments)
model Section {
  id        String    @id @default(uuid())
  name      String    @unique // e.g., "Mining", "Mechanical"
  
  // Many-to-Many: A section has many programs
  programs  Program[] @relation("ProgramToSection")

  @@map("sections")
}

// 3. Master Program Catalog
model Program {
  id             String            @id @default(uuid())
  name           String            @unique
  category       TrainingCategory  // FUNCTIONAL, BEHAVIOURAL, or COMMON
  targetGrades   Grade[]           // Array: can be for both [EXECUTIVE, WORKMAN]
  
  // Many-to-Many: A program can belong to many sections
  sections       Section[]         @relation("ProgramToSection")
  
  // Relation to nominations
  nominations    Nomination[]
  batches        NominationBatch[]
  cohortPrograms CohortProgram[]   // Cohort usage

  @@map("programs")
}

enum TrainingCategory {
  FOUNDATIONAL
  FUNCTIONAL
  BEHAVIOURAL
  COMMON
}

// --- UPDATED EXISTING TABLES ---

// 4. Updated Nomination Table (TNI Table)
model Nomination {
  id             String   @id @default(uuid())
  empId          String   @map("emp_id")
  programId      String   @map("program_id")
  
  // Metadata for the snapshot
  status         String   @default("Pending") // Pending, Batched, Completed
  source         String   @default("MANUAL") // MANUAL (TNI) or QR (Direct)
  justification  String?  @db.Text
  
  batchId        String?  @map("batch_id")

  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  employee       Employee         @relation(fields: [empId], references: [id], onDelete: Cascade)
  program        Program          @relation(fields: [programId], references: [id], onDelete: Cascade)
  batch          NominationBatch? @relation(fields: [batchId], references: [id], onDelete: SetNull)

  // Manager Approval Workflow
  managerApprovalStatus String   @default("Pending") // Pending, Approved, Rejected
  managerRejectionReason String? @map("manager_rejection_reason")

  @@unique([empId, batchId]) // Prevent duplicate nomination for same batch
  @@map("nominations")
}

// 5. NEW Nomination Batch Table (Groups participants)
model NominationBatch {
  id              String           @id @default(uuid())
  name            String?          // e.g., "Feb 2026 Safety Batch"
  programId       String           @map("program_id")
  
  status          String           @default("Forming") // Forming, Scheduled, Completed
  createdAt       DateTime         @default(now()) @map("created_at")
  
  // Relations
  program         Program          @relation(fields: [programId], references: [id])
  nominations     Nomination[]
  trainingSession TrainingSession?

  @@map("nomination_batches")
}

// --- REST OF YOUR ORIGINAL TABLES (RETAINED) ---

model TrainingSession {
  id                        String       @id @default(uuid())
  programName               String       @map("program_name")
  trainerName               String?      @map("trainer_name")
  startDate                 DateTime     @map("start_date")
  endDate                   DateTime     @map("end_date")
  startTime                 String?      @map("start_time") // e.g. "10:00 am"
  endTime                   String?      @map("end_time")   // e.g. "5:00 pm"
  location                  String?
  topics                    String?      @db.Text
  feedbackCreationDate      DateTime?    @map("feedback_creation_date")
  templateType              String       @default("Technical") @map("template_type")
  emailsSent                Boolean      @default(false) @map("emails_sent")
  feedbackReminderSent      Boolean      @default(false) @map("feedback_reminder_sent")
  sendFeedbackAutomatically Boolean      @default(false) @map("send_feedback_automatically")
  requireManagerApproval    Boolean      @default(true) @map("require_manager_approval")
  
  nominationBatchId         String?      @unique @map("nomination_batch_id")

  createdAt                 DateTime     @default(now()) @map("created_at")
  enrollments               Enrollment[]
  
  // Relations
  nominationBatch           NominationBatch? @relation(fields: [nominationBatchId], references: [id])
  cohortProgram             CohortProgram?   // If this session is part of a cohort

  @@unique([programName, startDate, endDate, trainerName])
  @@index([startDate])
  @@index([endDate])
  @@index([feedbackCreationDate])
  @@map("training_sessions")
}

model Enrollment {
  id                    String          @id @default(uuid())
  sessionId             String          @map("session_id")
  employeeName          String          @map("employee_name")
  employeeEmail         String          @map("employee_email")
  managerEmail          String          @map("manager_email")
  empId                 String?         @map("emp_id")
  managerName           String?         @map("manager_name")
  status                String          @default("Pending")
  preTrainingRating     Int?            @map("pre_training_rating")
  postTrainingRating    Int?            @map("post_training_rating")
  trainingRating        Int?            @map("training_rating")
  contentRating         Int?            @map("content_rating")
  trainerRating         Int?            @map("trainer_rating")
  materialRating        Int?            @map("material_rating")
  recommendationRating  Boolean?        @map("recommendation_rating")
  topicsLearned         String?         @map("topics_learned")
  actionPlan            String?         @map("action_plan")
  suggestions           String?         @map("suggestions")
  q1_Relevance          Int?            @map("q1_relevance")
  q2_Application        Int?            @map("q2_application")
  q3_Performance        Int?            @map("q3_performance")
  q4_Influence          Int?            @map("q4_influence")
  q5_Efficiency         Int?            @map("q5_efficiency")
  averageRating         Float?          @map("average_rating")
  managerAgrees         String?         @map("manager_agrees")
  managerComment        String?         @map("manager_comment")
  updatedAt             DateTime        @default(now()) @map("updated_at")
  session               TrainingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([sessionId, employeeEmail])
  @@index([sessionId])
  @@index([status])
  @@map("enrollments")
}

model Trainer {
  id        String   @id @default(uuid())
  name      String   @unique
  email     String?  @unique
  phone     String?
  createdAt DateTime @default(now()) @map("created_at")

  @@map("trainers")
}

model Designation {
  id        String   @id @default(uuid())
  name      String   @unique
  grade     String?  // Optional grade mapping (e.g., "M3", "Executive")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("designations")
}

model Location {
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now()) @map("created_at")

  @@map("locations")
}

enum Role {
  ADMIN
  MANAGER
  USER
  TRAINER
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  role      Role     @default(USER)
  createdAt DateTime @default(now()) @map("created_at")

  @@map("users")
}

// --- TROUBLESHOOTING LIBRARY SYSTEM ---

// 1. Master Product (Machine) List
model TroubleshootingProduct {
  id          Int      @id @default(autoincrement()) // Using Int to match provided data (ProdID)
  name        String   @unique
  viewSeq     Int      @default(0) @map("view_seq")
  userView    Int      @default(0) @map("user_view")
  keywords    String?
  legacyId    String?  @unique @map("legacy_source_id") // For CSV Import mapping
  imageUrl    String?  @map("image_url")  // Add this field if not present in your earlier plan but good for "grid of Products"

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  productFaults ProductFault[]

  @@map("troubleshooting_products")
}

// 2. Fault Library (Master Complaint List)
model FaultLibrary {
  id          String   @id @default(uuid())
  faultCode   String?  @unique @map("fault_code") // For "F001" style codes if needed
  name        String   @unique // "Engine Overheating" - Unique to avoid duplication
  viewSeq     Int      @default(0) @map("view_seq")
  legacyId    String?  @unique @map("legacy_source_id") // For CSV Import mapping

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  productMappings ProductFault[]

  @@map("fault_library")
}

// 3. Product-Fault Bridge (Logic: Which machine has which fault)
model ProductFault {
  id          String   @id @default(uuid())
  productId   Int      @map("product_id")
  faultId     String   @map("fault_id")
  
  viewSeq     Int      @default(0) @map("view_seq")
  notes       String?  // Machine-specific cautions or notes
  keywords    String?  // Machine-specific search tags

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  product     TroubleshootingProduct @relation(fields: [productId], references: [id])
  fault       FaultLibrary           @relation(fields: [faultId], references: [id])
  
  // Downstream: The causes for this specific product-fault context
  causes      FaultCause[]

  @@unique([productId, faultId]) // Prevent duplicate linking
  @@map("product_faults")
}

// 4. Cause Library (Master Cause/Remedy List)
model CauseLibrary {
  id          String   @id @default(uuid())
  name        String   @unique // "Low Coolant Level"
  justification String?  @db.Text
  action      String?  @db.Text // The fix
  symptoms    String?  @db.Text
  manualRef   String?  @map("manual_ref")
  
  imageUrl    String?  @map("image_url")

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  faultMappings FaultCause[]

  @@map("cause_library")
}

// 5. Fault-Cause Bridge (Logic: Diagnostic Sequence)
model FaultCause {
  id             String   @id @default(uuid())
  productFaultId String   @map("product_fault_id")
  causeId        String   @map("cause_id")
  
  seq            Int      @default(0) // The order of checking (1, 2, 3...)
  isLikely       Boolean  @default(false) @map("is_likely")
  isActive       Boolean  @default(true) @map("is_active")
  justification  String?  @db.Text

  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  productFault   ProductFault @relation(fields: [productFaultId], references: [id], onDelete: Cascade)
  cause          CauseLibrary @relation(fields: [causeId], references: [id])

  @@unique([productFaultId, causeId])
  @@index([productFaultId, seq])
  @@map("fault_causes")
}

// 6. Feedback System
model TroubleshootingFeedback {
  id        Int      @id @default(autoincrement())
  rating    Int      // 1-5 Star Rating
  isHelpful Boolean  @map("is_helpful") // "Was this useful?"
  comments  String?  @db.Text
  
  // Contact Info
  name      String
  mobile    String
  email     String?

  createdAt DateTime @default(now()) @map("created_at")

  @@map("troubleshooting_feedback")
}

// 7. Analytics Events
model TroubleshootingEvent {
  id        String   @id @default(uuid())
  type      String   // e.g. "GUIDE_SKIPPED"
  createdAt DateTime @default(now()) @map("created_at")

  @@map("troubleshooting_events")
}

// 8. Rate Limiting (Security)
model RateLimit {
  key       String   @id
  count     Int      @default(0)
  expiresAt DateTime @map("expires_at")
  
  @@map("rate_limits")
}

// --- COHORT SYSTEM (Multi-Program Learning Journeys) ---

// 9. Cohort — A named group of students going through multiple programs
model Cohort {
  id          String   @id @default(uuid())
  name        String   // e.g. "Inplant Batch 2026", "Technicians Batch"
  description String?  @db.Text
  status      String   @default("Draft") // Draft, Active, Completed

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  programs    CohortProgram[]   // Programs in this journey
  members     CohortMember[]    // Students in this cohort
  feedbacks   CohortFeedback[]  // Overall cohort evaluations

  @@map("cohorts")
}

// 10. CohortProgram — Which programs are part of this cohort
model CohortProgram {
  id        String  @id @default(uuid())
  cohortId  String  @map("cohort_id")
  programId String  @map("program_id")
  seq       Int     @default(0) // Suggested order (flexible)
  status    String  @default("Pending") // Pending, InProgress, Completed

  // Link to a TrainingSession when scheduled
  sessionId String? @unique @map("session_id")

  // Relations
  cohort    Cohort           @relation(fields: [cohortId], references: [id], onDelete: Cascade)
  program   Program          @relation(fields: [programId], references: [id])
  session   TrainingSession? @relation(fields: [sessionId], references: [id])

  @@unique([cohortId, programId])
  @@map("cohort_programs")
}

// 11. CohortMember — Students enrolled in a cohort journey
model CohortMember {
  id            String    @id @default(uuid())
  cohortId      String    @map("cohort_id")
  employeeId    String    @map("employee_id")
  status        String    @default("Active") // Active, Dropped, Completed
  joinedAt      DateTime  @default(now()) @map("joined_at")
  completedAt   DateTime? @map("completed_at")
  certificateId String?   @map("certificate_id") // Graduation tracking

  // Relations
  cohort   Cohort   @relation(fields: [cohortId], references: [id], onDelete: Cascade)
  employee Employee @relation(fields: [employeeId], references: [id])

  @@unique([cohortId, employeeId])
  @@map("cohort_members")
}

// 12. CohortFeedback — Overall journey evaluation (sent to manager)
model CohortFeedback {
  id        String   @id @default(uuid())
  cohortId  String   @map("cohort_id")
  empId     String   @map("emp_id")

  rating    Int      // 1-5 Overall Journey Rating
  comments  String?  @db.Text
  managerCc Boolean  @default(true) @map("manager_cc")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  cohort   Cohort   @relation(fields: [cohortId], references: [id], onDelete: Cascade)
  employee Employee @relation(fields: [empId], references: [id], onDelete: Cascade)

  @@unique([cohortId, empId])
  @@map("cohort_feedbacks")
}
